<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../iron-media-query/iron-media-query.html">
<link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html">
<!--
`optinomic-chart-profile`
Profile Charts

@demo demo/index.html 
-->
<dom-module id="optinomic-chart-profile">
    <template>
        <style include="iron-flex iron-flex-alignment">
        :host {
            display: block;
            --app-grid-columns: 3;
            --app-grid-item-height: 100px;
        }
        
        .container {
            width: 100%;
            display: block;
        }
        
        html,
        body {
            font-family: 'Roboto', sans-serif !important;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            min-height: 100%;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .large {
            font-size: 125%;
        }
        
        .small {
            font-size: 75%;
        }
        
        a {
            text-decoration: none;
        }
        
        h1,
        .display-1 {
            font-size: 34.7px;
            font-weight: 100;
            line-height: 42px;
            color: #757575;
            font-family: 'Roboto', sans-serif !important;
        }
        
        h2,
        .headline {
            font-size: 24.2px;
            font-weight: 300;
            line-height: 33.6px;
            color: #616161;
        }
        
        h3,
        .title {
            font-size: 20px;
            font-weight: 300;
            letter-spacing: 0.005em;
            color: #424242;
        }
        
        h4,
        .subhead {
            font-size: 15.8px;
            font-weight: 300;
            letter-spacing: 0.010em;
            line-height: 25.2px;
            color: #212121;
        }
        
        p,
        .body-1 {
            font-size: 13.7px;
            font-weight: 400;
            letter-spacing: 0.010em;
            line-height: 21px;
            color: #212121;
        }
        
        b,
        .body-2 {
            font-size: 13.7px;
            font-weight: 500;
            letter-spacing: 0.010em;
            line-height: 25.2px;
            color: #212121;
        }
        
        .caption {
            font-size: 10.6px;
            letter-spacing: 0.020em;
            line-height: 70% !important;
            color: #757575;
        }
        
        .grid-border-top {
            border-top-color: #E0E0E0;
            border-top-style: solid;
            border-top-width: 1px;
        }
        
        div.relative {
            position: relative;
            width: 100%;
        }
        
        .svg_grafic {}
        
        .svg_grafic_inner {
            margin-left: 6px;
            margin-right: 6px;
            background-color: #FFFFFF;
        }
        
        div.absolute_left {
            position: absolute;
            top: 0;
            left: 0;
        }
        
        div.absolute_right {
            position: absolute;
            top: 0;
            right: 0;
        }
        
        div.absolute_full {
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
        }
        
        div.beschriftung_element {
            overflow: hidden !important;
        }
        
        .beschriftung_element_title {
            font-size: 12.6px;
            letter-spacing: 0.020em;
            line-height: 105% !important;
        }
        
        .beschriftung_element_subtitle {
            font-size: 10.6px;
            letter-spacing: 0.020em;
            line-height: 105% !important;
            color: #757575;
            margin-top: -10px;
        }
        
        .fade {
            opacity: 0.7;
            transition: opacity .25s ease-in-out;
            -moz-transition: opacity .25s ease-in-out;
            -webkit-transition: opacity .25s ease-in-out;
        }
        
        .fade:hover {
            opacity: 1;
        }
        
        .fade_in {
            -webkit-animation: fadein 2s;
            /* Safari, Chrome and Opera > 12.1 */
            -moz-animation: fadein 2s;
            /* Firefox < 16 */
            -ms-animation: fadein 2s;
            /* Internet Explorer */
            -o-animation: fadein 2s;
            /* Opera < 12.1 */
            animation: fadein 2s;
        }
        
        @keyframes fadein {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        /* Firefox < 16 */
        
        @-moz-keyframes fadein {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        /* Safari, Chrome and Opera > 12.1 */
        
        @-webkit-keyframes fadein {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        /* Internet Explorer */
        
        @-ms-keyframes fadein {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        /* Opera < 12.1 */
        
        @-o-keyframes fadein {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        .start_container {
            margin-bottom: 24px;
        }
        
        .right {
            text-align: right;
        }
        
        .left {
            text-align: left;
        }
        </style>
        <!-- START - Grafik -->
        <div class="start_container">
            <div class="layout horizontal flex">
                <p class="flex" style$="width:[[def.scale_item_width]]">
                    [[start.left_title]]<span class="caption"><br>[[start.left_text]]</span>
                </p>
                <p class="flex right" style$="width:[[def.scale_item_width]]">
                    [[start.right_title]]<span class="caption"><br>[[start.right_text]]</span>
                </p>
            </div>
        </div>
        <!-- CONTENT - Grafik -->
        <div class="relative" style$="height:[[def.svg_height_style]]">
            <!-- SVG - Grafik -->
            <div id="svg_grafic" class="svg_grafic">
                <div class="svg_grafic_inner">
                    <template is="dom-if" if="{{def.svg_width_set}}">
                        <svg-container id="SvgContainer" view-box$="0 0 100 [[def.svg_height]]" width$="[[def.svg_width_100]]" height$="[[def.svg_height_style]]">
                            <svg-component is="g" id="ranges" class="fade_in">
                                <template is="dom-repeat" items="[[ranges]]" as="range">
                                    <svg-component class="fade" is="rect" x$="[[range.x]]" y="0" fill$="[[range.rgb]]" width$="[[range.width]]" height$="[[range.height]]" stroke-width="none">
                                    </svg-component>
                                </template>
                            </svg-component>
                            <svg-component is="g" id="baseGrid">
                                <template is="dom-repeat" items="[[scales]]" as="scale">
                                    <svg-component is="line" x1="0" y1$="[[scale.bottomline]]" x2$="[[def.svg_width_100]]" y2$="[[scale.bottomline]]" stroke="#D7CCC8" stroke-width="0.5">
                                    </svg-component>
                                    <template is="dom-if" if="[[scale.first]]">
                                        <svg-component is="line" x1="0" y1$="[[scale.topline]]" x2$="[[def.svg_width_100]]" y2$="[[scale.topline]]" stroke="#D7CCC8" stroke-width="0.5">
                                        </svg-component>
                                    </template>
                                    <template is="dom-if" if="[[def.show_baseline]]">
                                    <svg-component is="line" x1="0" y1$="[[scale.baseline]]" x2$="[[def.svg_width_100]]" y2$="[[scale.baseline]]" stroke$="[[def.color_grid]]" stroke-width="1">
                                    </svg-component>
                                    </template>

                                </template>
                                <template is="dom-repeat" items="[[verticalGrid]]" as="grid">
                                    <template is="dom-if" if="[[grid.zero]]">
                                        <svg-component is="line" x1$="[[grid.x]]" y1="0" x2$="[[grid.x]]" y2$="[[grid.y]]" stroke$="[[def.color_grid]]" stroke-width="2">
                                        </svg-component>
                                    </template>
                                    <template is="dom-if" if="[[!grid.zero]]">
                                        <svg-component is="line" x1$="[[grid.x]]" y1="0" x2$="[[grid.x]]" y2$="[[grid.y]]" stroke$="[[def.color_grid]]" stroke-width="0.1">
                                        </svg-component>
                                    </template>
                                </template>
                            </svg-component>
                            <svg-component is="g" id="scoreProfiles" class="fade_in">
                                <template is="dom-repeat" items="[[score_profiles]]" as="score">
                                    <svg-component is="polyline" points$="[[score.points_str]]" fill="none" stroke$="[[score.color]]" stroke-width="4">
                                    </svg-component>
                                </template>
                                <template is="dom-repeat" items="[[scales]]" as="scale">
                                    <template is="dom-repeat" items="[[scale.scores]]" as="score">
                                        <svg-component class="fade" is="circle" r="5" cx$="[[score.value_x]]" cy$="[[score.value_y]]" fill="rgba(255, 255, 255, 0.5)" stroke$="[[def.color_grid]]" stroke-width="1">
                                        </svg-component>
                                    </template>
                                </template>
                            </svg-component>
                        </svg-container>
                    </template>
                </div>
            </div>
            <!-- Skalenbeschriftung Links/Rechts -->
            <template is="dom-if" if="{{wide}}">
                <div class="absolute_left" style$="height:[[def.svg_height_style]]; width:[[def.scale_item_width]]">
                    <template is="dom-repeat" id="right_beschriftung" items="[[scales]]" as="s">
                        <div class="beschriftung_element fade" style$="height:[[def.scale_item_height]]; width:[[def.scale_item_width]]" right>
                            <p class="beschriftung_element_title right">[[s.left_title]]
                            </p>
                            <p class="beschriftung_element_subtitle fade_in right">[[s.left_text]]</p>
                        </div>
                    </template>
                </div>
                <div class="absolute_right" style$="height:[[def.svg_height_style]]; width:[[def.scale_item_width]]">
                    <template is="dom-repeat" id="left_beschriftung" items="[[scales]]" as="s">
                        <div class="beschriftung_element fade" style$="height:[[def.scale_item_height]]; max-height:[[def.scale_item_height]]; width:[[def.scale_item_width]]">
                            <p class="beschriftung_element_title">[[s.right_title]]
                            </p>
                            <p class="beschriftung_element_subtitle fade_in">[[s.right_text]]</p>
                        </div>
                    </template>
                </div>
            </template>
        </div>
        <!-- Media Query -->
        <iron-media-query query="(min-width: 580px)" query-matches="{{wide}}" on-query-matches-changed="__setCSS"></iron-media-query>
        <!-- SPACE -->
        <div style="margin-top: 150px;">
            &nbsp;
        </div>
        <hr>
        <!-- DEBUG -->
        <div>
            <pre>
                 svg_height_style=[[def.svg_height_style]] 
                 scale_item_height=[[def.scale_item_height]] 
                 scale_item_width=[[def.scale_item_width]] 
                 >600px: {{wide}} | 4800px: {{xs}}
            </pre>
        </div>
    </template>
    <script>

    getColor = function(id) {
        var colors = [];
        colors.push("#3F51B5");
        colors.push("#E91E63");
        colors.push("#00BCD4");
        colors.push("#8BC34A");
        colors.push("#FFC107");
        colors.push("#795548");

        colors.push("#673AB7");
        colors.push("#F44336");
        colors.push("#03A9F4");
        colors.push("#4CAF50");
        colors.push("#FFEB3B");
        colors.push("#FF5722");

        colors.push("#2196F3");
        colors.push("#9C27B0");
        colors.push("#009688");
        colors.push("#CDDC39");
        colors.push("#FF9800");
        colors.push("#607D8B");

        var selected_id = id;

        return colors[selected_id];
    };

    hexToRGB = function(hex, alpha) {
        var h = "0123456789ABCDEF";
        var r = h.indexOf(hex[1]) * 16 + h.indexOf(hex[2]);
        var g = h.indexOf(hex[3]) * 16 + h.indexOf(hex[4]);
        var b = h.indexOf(hex[5]) * 16 + h.indexOf(hex[6]);
        if (alpha) return "rgba(" + r + ", " + g + ", " + b + ", " + alpha + ")";
        else return "rgb(" + r + ", " + g + ", " + b + ")";
    };
    __autoMinMax = function(do_min, do_max, d, all_scales) {
        // Init
        if (do_min) {
            d.item_min = 0;
        };
        if (do_max) {
            d.item_max = 0;
        };

        // Check in scales/scores
        all_scales.forEach(function(scale, scaleID) {
            scale.scores.forEach(function(score, scoreID) {
                if (do_min) {
                    if (score.value < d.item_min) {
                        d.item_min = score.value;
                    };
                };
                if (do_max) {
                    if (score.value > d.item_max) {
                        d.item_max = score.value;
                    };
                };
            });
        });


        //Round a number upward to its nearest integer:

        if (do_min) {
            if (d.item_min < 0) {
                d.item_min = Math.ceil(Math.abs(d.item_min)) + 1;
                d.item_min = d.item_min * -1;
            } else {
                d.item_min = Math.ceil(Math.abs(d.item_min)) + 1;
            };
        };
        if (do_max) {
            if (d.item_max < 0) {
                d.item_max = Math.ceil(Math.abs(d.item_max)) + 1;
                d.item_max = d.item_max * -1;
            } else {
                d.item_max = Math.ceil(Math.abs(d.item_max)) + 1;
            };
        };

        return d;
    };

    __getXPos = function(min, max, svg_width_100, current_value) {
        var width_value = null
        if (current_value !== undefined) {
            current_value = current_value;

            var width_100 = Math.abs(min) + Math.abs(max);
            width_value = (svg_width_100 / width_100) * (current_value + Math.abs(min));
        };
        return width_value;
    };


    Polymer({

        is: 'optinomic-chart-profile',


        __setCSS: function() {
            console.log('setCSS:', this.wide);

            if (this.wide === true) {
                this.$.svg_grafic.style['margin-left'] = this.def.scale_item_width;
                this.$.svg_grafic.style['margin-right'] = this.def.scale_item_width;
            } else {
                this.$.svg_grafic.style['margin-left'] = 0;
                this.$.svg_grafic.style['margin-right'] = 0;
            };
        },

        __setInit: function() {

            __getScorePath = function(current_score, path) {
                var dots_count = (path.split(".").length - 1)

                var dive = [];
                for (i = 0; i < dots_count; i++) {
                    var n = path.indexOf(".");
                    var item = path.substring(0, n);
                    path = path.substring(n + 1, path.length);
                    dive.push(item);
                    if (i === dots_count - 1) {
                        dive.push(path);
                    };
                };

                var return_value = null;
                var data_dive = JSON.parse(JSON.stringify(current_score));

                // console.log('__getScorePath', data_dive, path);

                for (i = 0; i < dive.length; i++) {
                    data_dive = data_dive[dive[i]];
                    if (i === dots_count) {
                        return_value = data_dive;

                        return return_value;
                    };
                };
            };


            var scales = this.scales;
            var scores = this.scores.data;
            var def = JSON.parse(JSON.stringify(this.options));


            def.only_one = true;
            if (this.scales.length > 1) {
                def.only_one = false;
            };
            def.svg_height = def.item_height * (scales.length);
            def.svg_height_style = def.svg_height + 'px';
            def.scale_item_height = (def.item_height - 0) + 'px';

            def.scale_item = ((def.item_height - def.item_text_wide) * 4)
            def.scale_item_width = def.scale_item + 'px';


            def.svg_width_set = false;
            def.svg_width = this.$.svg_grafic.offsetWidth;
            if (def.svg_width !== 0) {
                def.svg_width_set = true;
                def.svg_width_100 = def.svg_width - (2 * def.scale_item) - 12;
                console.log('SET!', this.def.svg_width, this.options);
            };


            scales.forEach(function(scale, scaleID) {
                scale.id = scaleID;
                scale.topline = scaleID * def.item_height;
                scale.baseline = scale.topline + (def.item_height / 2);
                scale.bottomline = scale.topline + def.item_height;

                scale.first = false;
                if (scaleID === 0) {
                    scale.first = true;
                };

                scale.last = false;
                if (scaleID === scales.length - 1) {
                    scale.last = true;
                };

                scale.scores = [];
                scores.forEach(function(score, scoreID) {
                    var score_obj = {
                        "value": null
                    };

                    if (scale.score_path) {
                        score_obj.value = this.__getScorePath(score, scale.score_path);
                    };

                    scale.scores.push(score_obj);
                });
            });

            console.log('(!) Definition:', def);

            this.def = def;
            this.scales = scales;


            // Auto Min/Max
            var do_min = false;
            if ((def.min === 'auto') || (def.min === undefined)) {
                do_min = true;
            } else {
                item_min = parseInt(def.min);
            };

            var do_max = false;
            if ((def.max === 'auto') || (def.max === undefined)) {
                do_max = true;
            } else {
                item_max = parseInt(def.max);
            };

            if (do_max || do_min) {
                __autoMinMax(do_min, do_max, this.def, this.scales);
            };

            console.log('(!) Scales:', this.scales);
        },

        __setScoreProfiles: function() {
            var my_min = this.def.item_min;
            var my_max = this.def.item_max;

            if (this.def.svg_width_100 === 0) {
                var my_100 = 100;
            } else {
                var my_100 = this.def.svg_width_100;
            };

            // console.log('__setValueX: ', my_min, my_max);

            var scores_points = [];
            this.scales.forEach(function(scale, scaleID) {
                scale.scores.forEach(function(score, scoreID) {
                    score.value_x = __getXPos(my_min, my_max, my_100, score.value);
                    score.value_y = scale.baseline;

                    var score_obj = {
                        "text": "Messung",
                        "points": [],
                        "points_str": "",
                        "color": getColor(scoreID)
                    };

                    scores_points[scoreID] = scores_points[scoreID] === undefined ? score_obj : scores_points[scoreID];

                    scores_points[scoreID].points.push(score.value_x + ',' + score.value_y);
                    scores_points[scoreID].points_str = scores_points[scoreID].points_str + score.value_x + ',' + score.value_y + ' ';
                    // <polyline points="20,30 40,25 60,40 80,120 120,140 200,180" style="fill:none;stroke:black;stroke-width:3" />
                });
            });

            this.score_profiles = scores_points;

            console.log('score_profiles', this.score_profiles);
        },

        __setVerticalGrid: function() {
            var def = this.def;

            vGrid = [];

            for (i = def.item_min; i < def.item_max + 1; i++) {
                var grid_object = {
                    "x": __getXPos(def.item_min, def.item_max, def.svg_width_100, i),
                    "y": def.svg_height,
                    "zero": false
                };

                if (i === 0) {
                    grid_object.zero = true;
                };

                vGrid.push(grid_object);
            };

            this.verticalGrid = vGrid;

            console.log('__setVerticalGrid', this.verticalGrid);
        },

        __setRanges: function() {
            var ranges = this.ranges;
            var def = this.def;
            var alpha = 0.5;


            ranges.forEach(function(range, rangeID) {
                range.id = rangeID;
                range.rgb = hexToRGB(range.color, alpha);

                range.start = range.range_start;
                if (range.range_start === -999) {
                    range.start = def.item_min;
                } else {

                };

                range.stop = range.range_stop;
                if (range.range_stop === 999) {
                    range.stop = def.item_max;
                };

                range.width = (__getXPos(def.item_min, def.item_max, def.svg_width_100, range.stop)) - (__getXPos(def.item_min, def.item_max, def.svg_width_100, range.start));
                range.x = __getXPos(def.item_min, def.item_max, def.svg_width_100, range.start);

                range.height = def.svg_height;
            });
            console.log('__setRanges', this.ranges);
        },


        properties: {
            options: {
                type: Object
            },
            start: {
                type: Object
            },
            scales: {
                type: Object
            },
            scores: {
                type: Object
            },
            ranges: {
                type: Object
            },
        },

        attached: function() {
            this.__setInit();
            this.__setCSS();
            this.__setScoreProfiles();
            this.__setVerticalGrid();
            this.__setRanges();


        },

        ready: function() {

            this.__setInit();


            console.log('READY: clientWidth', this.$.svg_grafic.clientWidth);

        },

    });
    </script>
</dom-module>
<!-- 
http://plnkr.co/edit/pegYFTcr9koAZEg7pTMf?p=preview
-->
<dom-module id="svg-container">
    <template>
        <svg id="svg" version="1.1" xmlns="http://www.w3.org/2000/svg" width="100%" preserveAspectRatio="xMinYMin meet"></svg>
        <content select="svg-component"></content>
    </template>
    <script>
    Polymer({
        is: 'svg-container',

        attached: function() {
            for (var i = 0; i < this.attributes.length; i++) {
                this.$.svg.setAttribute(Polymer.CaseMap.dashToCamelCase(this.attributes[i].name), this.attributes[i].value);
            }
        }
    });
    </script>
</dom-module>
<dom-module id="svg-component">
    <template>
        <content select="svg-component"></content>
    </template>
    <script>
    SvgComponent = Polymer({
        is: 'svg-component',

        _node: {},

        _namespace: 'http://www.w3.org/2000/svg',

        get rootElement() {
            if (this.parentNode.nodeName === 'SVG-CONTAINER')
                return this.parentNode.$.svg;
            else
                return this.parentNode._node;
        },

        factoryImpl: function(attributes) {
            for (var key in attributes)
                this.setAttribute(key, attributes[key]);
        },

        attached: function() {
            var is = this.attributes.is.value;

            if (is !== undefined) {
                this._node = document.createElementNS(this._namespace, is);
                for (var i = 0; i < this.attributes.length; i++) {
                    if (this.attributes[i].name !== 'is')
                        this._node.setAttribute(this.attributes[i].name, this.attributes[i].value);
                }
                this.rootElement.appendChild(this._node);
            }
        }
    });
    </script>
</dom-module>
